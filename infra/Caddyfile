{
    admin off
    storage file_system {
        root /var/lib/caddy/data
    }
}

{$CADDY_DOMAIN:-$CADDY_LOCAL_DOMAIN} {
    tls {$CADDY_TLS_EMAIL:-$CADDY_TLS_LOCAL_EMAIL} {
        on_demand
    }

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-Robots-Tag "noindex, nofollow"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:;"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }

    @api {
        path /api/*
    }

    reverse_proxy @api backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    @frontend {
        path /*
    }

    reverse_proxy @frontend frontend:3000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    @health {
        path /health
    }

    respond @health "OK" 200
}

# LAN profile (internal/self-signed)
:80, :8080 {
    header {
        Strict-Transport-Security "max-age=0"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    @api {
        path /api/*
    }

    reverse_proxy @api backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
    }

    @frontend {
        path /*
    }

    reverse_proxy @frontend frontend:3000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
    }

    @health {
        path /health
    }

    respond @health "OK" 200
}
